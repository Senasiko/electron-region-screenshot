"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var electron=require("electron"),url=_interopDefault(require("url")),path=_interopDefault(require("path")),fs=_interopDefault(require("fs")),child_process=require("child_process");
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function __awaiter(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{u(n.next(e))}catch(e){o(e)}}function c(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?s(e.value):new r((function(t){t(e.value)})).then(i,c)}u((n=n.apply(e,t||[])).next())}))}const{screen:screen}=electron.remote;class ScreenshotTaker{constructor(){this.outputPath="";const e=screen.getCursorScreenPoint();this.currentScreen=screen.getDisplayNearestPoint({x:e.x,y:e.y}),"win32"===process.platform?this.bounds=this.getWindowsBounds():this.bounds=this.getMacBounds()}getMacBounds(){return this.currentScreen.bounds}getWindowsBounds(){const e=screen.getAllDisplays().sort((e,t)=>e.bounds.x===t.bounds.x?e.bounds.y-t.bounds.y:e.bounds.x-t.bounds.x),t=e[e.length-1];return{x:0,y:0,width:t.bounds.x+t.bounds.width,height:t.bounds.y+t.bounds.height}}start(){return __awaiter(this,void 0,void 0,(function*(){const e=screen.getAllDisplays().findIndex(e=>e.id===this.currentScreen.id),t=`cap_${e}.png`,r=electron.remote.app.getPath("userData");this.outputPath=path.join(r,t);const n=process.platform;return"win32"===n&&(yield this.performWindowsCapture(this.outputPath)),"darwin"===n&&(yield this.performMacOSCapture(this.outputPath,e)),this.outputPath}))}clear(){fs.unlink(this.outputPath,()=>{})}performMacOSCapture(e,t){const r=child_process.spawn("screencapture",["-x","-D",`${t+1}`,e]);return this.waitCapturer(r)}performWindowsCapture(e){const t=child_process.spawn(path.join(__dirname,"nircmd.exe"),["savescreenshotfull",e]);return this.waitCapturer(t)}waitCapturer(e){let t,r;const n=new Promise((e,n)=>{t=e,r=n});return e.on("exit",()=>{t()}),e.on("error",e=>{r(e)}),n}}const{BrowserWindow:BrowserWindow}=electron.remote,clipRenderUrl="./screenshot/screen.html",ipc=electron.ipcRenderer;let win=null,_resolve=null,_reject=null,taker=null;function createChildWin(e,t){let r={alwaysOnTop:!0,show:!1,transparent:!0,frame:!1,movable:!1,resizable:!1,fullscreen:"win32"===process.platform||void 0,enableLargerThanScreen:!0,hasShadow:!1,width:t.width,height:t.height,x:t.x,y:t.y,webPreferences:{nodeIntegration:!0}};r=Object.assign(r,t);const n=new BrowserWindow(r);return n.setBounds({width:t.width,height:t.height}),n.loadURL(url.format({pathname:path.join(__dirname,e),protocol:"file",slashes:!0})),"darwin"===process.platform&&(n.setAlwaysOnTop(!0,"screen-saver"),n.setVisibleOnAllWorkspaces(!0),n.setFullScreenable(!1),n.show(),n.setVisibleOnAllWorkspaces(!1)),n}function reset(){var e;win&&win.close(),win=null,null===(e=taker)||void 0===e||e.clear()}function screenshot(){return __awaiter(this,void 0,void 0,(function*(){if(_resolve&&_reject)return Promise.reject(new Error("is cutting"));const e=new Promise((e,t)=>{_resolve=e,_reject=t});if(!win||win.isDestroyed())try{return taker=new ScreenshotTaker,taker.start().then(e=>{electron.ipcRenderer.send("capturer-data",e)}),win=createChildWin(clipRenderUrl,taker.bounds),win.on("closed",()=>{win=null}),win.on("ready-to-show",()=>{var e,t;null===(e=win)||void 0===e||e.show(),null===(t=win)||void 0===t||t.focus()}),win.webContents.executeJavaScript(`;window.cut(${taker.bounds.width}, ${taker.bounds.height});`),e}catch(e){return _reject&&_reject(e),void reset()}return Promise.reject(new Error("is cutting"))}))}ipc.on("shortcut-capture",(e,t)=>{screenshot()}),ipc.on("screenshot-success",(e,t)=>{reset(),_resolve&&_resolve(t.message),_resolve=null,_reject=null}),ipc.on("quit-cut",(e,t)=>{reset(),_reject&&_reject("quit cut"),_reject=null,_resolve=null}),module.exports={screenshot:screenshot};
