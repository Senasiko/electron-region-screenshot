"use strict";var __awaiter=function(t,e,s,a){return new(s||(s=Promise))((function(i,o){function h(t){try{r(a.next(t))}catch(t){o(t)}}function n(t){try{r(a.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(h,n)}r((a=a.apply(t,e||[])).next())}))};const{ipcRenderer:ipcRenderer,clipboard:clipboard,nativeImage:nativeImage,remote:remote}=require("electron"),fs=require("fs"),path=require("path");let screenCut;class ScreenCut{constructor(t,e){this.start={x:0,y:0,width:0,height:0},this.canvasMask=document.getElementById(t),this.width=e.width,this.height=e.height,this.image=document.getElementById("img"),this.state="ready",this.cuted=!1,this.isShowTool=!1,this.tool=document.querySelectorAll(".tool")[0],this.tip=document.querySelectorAll(".tipNum")[0],this.leftTopCursor=document.querySelectorAll(".left_top")[0],this.rightTopCursor=document.querySelectorAll(".right_top")[0],this.leftBottomCursor=document.querySelectorAll(".left_bottom")[0],this.rightBottomCursor=document.querySelectorAll(".right_bottom")[0],this.createMaskImg(),this.getMouse(),this.sendMsg("ready")}createMaskImg(){this.maskImg=document.getElementById("maskImg"),this.maskSvg=document.getElementById("maskSvg"),this.maskRect=document.getElementById("maskRect"),this.maskImg.setAttribute("href",this.image.src),this.createRect(0,0,0,0)}setImgUrl(t){var e;this.image.src=t,null===(e=this.maskImg)||void 0===e||e.setAttribute("href",t)}getMouse(){const t={x:0,y:0};this.start={x:0,y:0,width:0,height:0};const e=t=>this.cuted?"draging"===this.state?(this.dragEvent(t.pageX,t.pageY),!1):"zooming"===this.state?(this.zoomEvent(t.pageX,t.pageY),!1):void 0:(this.cutEvent(t.pageX,t.pageY),!1);let s=!1;return document.addEventListener("mousedown",t=>{document.onselectstart=function(){return!1};const s=t.target;return s.dataset.done?(this.done(),!1):s.dataset.save?(this.save(),!1):s.dataset.cancel?(this.cancel(),!1):s.dataset.close?(this.sendMsg("close"),!1):s.dataset.drag?(this.state="draging",this.canvas_x=t.clientX-this.canvasMask.offsetLeft,this.canvas_y=t.clientY-this.canvasMask.offsetTop,document.addEventListener("mousemove",e,!1),!1):s.dataset.zoom?(this.state="zooming",this.zoomOrigin=s.dataset.placement,this.start.x=this.canvasMask.offsetLeft,this.start.y=this.canvasMask.offsetTop,this.start.width=this.canvasMask.width,this.start.height=this.canvasMask.height,document.addEventListener("mousemove",e,!1),!1):(this.state="cuting",this.start.x=t.pageX,this.start.y=t.pageY,void document.addEventListener("mousemove",e,!1))},!1),document.addEventListener("mouseup",s=>{this.state;const a=s.target;if(a.dataset.done||a.dataset.cancel||a.dataset.save||a.dataset.close||a.dataset.drag||a.dataset.zoom){const t=parseInt(this.canvasMask.style.left)+this.canvasMask.width,s=parseInt(this.canvasMask.style.top)+this.canvasMask.height,a=parseInt(this.canvasMask.style.left),i=parseInt(this.canvasMask.style.top);this.showTool(t,s,a,i),document.removeEventListener("mousemove",e)}else t.x=s.pageX,t.y=s.pageY,document.removeEventListener("mousemove",e),this.isShowTool&&this.showTool(t.x,t.y,this.start.x,this.start.y);return!1},!1),document.addEventListener("click",t=>{if(t.target.dataset.drag){if(s)return void this.done();s=!0,setTimeout(()=>{s=!1},200)}},!1),{end:t}}createRect(t,e,s,a){var i,o,h,n;null===(i=this.maskRect)||void 0===i||i.setAttribute("x",s.toString()),null===(o=this.maskRect)||void 0===o||o.setAttribute("y",a.toString()),null===(h=this.maskRect)||void 0===h||h.setAttribute("width",(t-s).toString()),null===(n=this.maskRect)||void 0===n||n.setAttribute("height",(e-a).toString()),this.isShowTool=!0,this.hideTool()}maskShow(t,e,s,a){this.canvasMask.style.display="block",this.canvasMask.style.border="1px solid #FFF",this.canvasMask.style.left=`${s<t?s:t}px`,this.canvasMask.style.top=`${a<e?a-1:e-1}px`,this.canvasMask.width=t-s,this.canvasMask.height=e-a}clearCtx(){this.canvasMask.style.display="none",this.canvasMask.style.border="none"}clearMask(){var t,e,s,a;null===(t=this.maskRect)||void 0===t||t.setAttribute("x","0"),null===(e=this.maskRect)||void 0===e||e.setAttribute("y","0"),null===(s=this.maskRect)||void 0===s||s.setAttribute("width","0"),null===(a=this.maskRect)||void 0===a||a.setAttribute("height","0")}createImageData(){const t=this.canvasMask.width*devicePixelRatio,e=this.canvasMask.height*devicePixelRatio,s=parseInt(this.canvasMask.style.left)*devicePixelRatio,a=parseInt(this.canvasMask.style.top)*devicePixelRatio,i=document.createElement("canvas");i.width=this.width*devicePixelRatio,i.height=this.height*devicePixelRatio;const o=i.getContext("2d");return o.drawImage(this.image,0,0),this.RGBA2ImageData(o.getImageData(s,a,t,e))}RGBA2ImageData(t){const{width:e}=t,{height:s}=t,a=document.createElement("canvas");a.width=e,a.height=s;const i=a.getContext("2d"),o=i.createImageData(e,s);return o.data.set(t.data),i.putImageData(o,0,0),a.toDataURL()}tipShow(t,e,s,a){this.tip.innerHTML=`${Math.abs(t-s)}×${Math.abs(e-a)}`,this.tip.style.display="inline-block",this.tip.style.left=`${s<t?s:t}px`;let i=a<e?a-20:e-20;i<5&&(i=a),this.tip.style.top=`${i}px`}tipHide(){this.tip.style.display="none"}showTool(t,e,s,a){this.tool.style.display="block",this.tool.style.left=`${s<t?t-110:s}px`,this.height-e<50&&!(a<21)?this.tool.style.top=`${a-21}px`:this.height-e<50&&a<21?this.tool.style.top=`${a}px`:this.tool.style.top=`${e+3}px`,this.cuted=!0,this.isShowTool=!1,this.showCursor(t,e,s,a)}showCursor(t,e,s,a){this.leftTopCursor.style.top=`${a}px`,this.leftTopCursor.style.left=`${s}px`,this.rightTopCursor.style.top=`${a}px`,this.rightTopCursor.style.left=`${t-15}px`,this.leftBottomCursor.style.top=`${e-15}px`,this.leftBottomCursor.style.left=`${s}px`,this.rightBottomCursor.style.left=`${t-15}px`,this.rightBottomCursor.style.top=`${e-15}px`,this.leftTopCursor.style.display="block",this.rightTopCursor.style.display="block",this.leftBottomCursor.style.display="block",this.rightBottomCursor.style.display="block"}hideTool(){this.tool.style.display="none",this.leftTopCursor.style.display="none",this.rightTopCursor.style.display="none",this.leftBottomCursor.style.display="none",this.rightBottomCursor.style.display="none"}cutEvent(t,e){this.clearCtx();let s=this.start.x,a=this.start.y,i=t,o=e;i<s&&([s,i]=[i,s]),o<a&&([a,o]=[o,a]),this.createRect(i,o,s,a),this.maskShow(i,o,s,a),this.tipShow(i,o,s,a)}dragEvent(t,e){if(void 0===this.canvas_x||void 0===this.canvas_y)return;const s=document.body.offsetWidth,a=document.body.offsetHeight,i=t-this.canvas_x,o=e-this.canvas_y;i<0?this.canvasMask.style.left="0px":i>s-this.canvasMask.width?this.canvasMask.style.left=`${s-this.canvasMask.width}px`:this.canvasMask.style.left=`${i}px`,o<0?this.canvasMask.style.top="0px":o>a-this.canvasMask.height?this.canvasMask.style.top=`${a-this.canvasMask.height}px`:this.canvasMask.style.top=`${o}px`;const h=parseInt(this.canvasMask.style.left)+this.canvasMask.width,n=parseInt(this.canvasMask.style.top)+this.canvasMask.height,r=parseInt(this.canvasMask.style.left),l=parseInt(this.canvasMask.style.top);this.createRect(h,n,r,l),this.hideTool(),this.tipShow(h,n,r,l)}zoomEvent(t,e){let{x:s,y:a,width:i,height:o}=this.start,h=[];switch(this.zoomOrigin){case"left-top":h=[t,e,s+i,a+o];break;case"right-top":h=[s,e,t,a+o];break;case"left-bottom":h=[t,a,s+i,e];break;case"right-bottom":h=[s,a,t,e]}this.clearCtx();let[n,r,l,c]=h;l<n&&([n,l]=[l,n]),c<r&&([r,c]=[c,r]),this.createRect(l,c,n,r),this.maskShow(l,c,n,r),this.tipShow(l,c,n,r)}cancel(){this.cuted=!1,this.state="ready",this.clearCtx(),this.clearMask(),this.hideTool(),this.tipHide()}done(){const t=this.createImageData();clipboard.writeImage(nativeImage.createFromDataURL(t)),this.sendMsg("success",{path:null,base64:t})}save(){return __awaiter(this,void 0,void 0,(function*(){const t=this.createImageData();remote.getCurrentWindow().setAlwaysOnTop(!1);const{filePath:e}=yield remote.dialog.showSaveDialog({defaultPath:path.resolve(remote.app.getPath("userData"),`截图_${dateFormat()}.png`),filters:[{name:"Images",extensions:["jpg","png","gif"]}]});e?fs.writeFile(e,new Buffer(t.replace("data:image/png;base64,",""),"base64"),()=>{this.sendMsg("save",{path:e,base64:t})}):remote.getCurrentWindow().setAlwaysOnTop(!0)}))}sendMsg(t,e=null){ipcRenderer.send("screenshot-page",{type:t,message:e})}}function dateFormat(){const t=new Date;return`${t.getFullYear()}${t.getMonth()+1}${t.getDay()}_${t.getHours()}${t.getMinutes()}${t.getSeconds()}`}ipcRenderer.on("capturer-data",(t,e)=>{var s;null===(s=screenCut)||void 0===s||s.setImgUrl(e)}),window.cut=(t,e)=>{screenCut=new ScreenCut("canvasMask",{width:t,height:e})};
